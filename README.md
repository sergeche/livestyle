# Emmet LiveStyle

Emmet LiveStyle — это плагин для двунаправленного (редактор↔браузер) живого редактирования CSS нового поколения.

Существующие инструменты (LiveReload, CodeKit и прочие) работают по очень простому принципу: запускается специальный сервис, который отслеживает момент изменения CSS-файла и просто перезагружает страницу, к которой привязан этот файл. Более новые инструменты (Adobe Brackets, WebStorm) используют Chrome Debugging Protocol для замены обновлённого CSS-файла «на лету». Это даёт более высокую отзывчивость и позволяет не терять состояние редактируемой страницы, так как она не перезагружается.

Но у всех этих инструментов есть ряд существенных недостатков:

* Работают только с локальными файлами или специально запущенным локальным веб-сервером.
* Работают только в одном направлении (редактор→браузер).
* CSS-файлы в браузере должны быть идентичны файлам в редакторе.

Это всё означает, что если вы делаете что-то сложнее обычных статических страничек (например, используете CMS, сборку ресурсов и т.д.) эти инструменты становятся бесполезными.

Все эти проблемы решает LiveStyle. Изменения ресурсов происходят с помощью специального *патчинга*: когда происходит изменение CSS-файла, ELS выполняет *структурный анализ* изменений и строит специальный патч. В отличие от обычных патчей, которые описывают, как поменялись символы в файле, этот патч описывает, *как поменялась структура CSS*. Например, «в селекторе `body` значение свойства `padding` изменилось на `10px` и было удалено свойство `color`». Это означает, что такой патч *может быть применён к любому CSS-файлу*: будут обновлены найденные селекторы и свойства, а отсутсвующие будут автоматически созданы.

Сам LiveStyle не привязывается к каким-либо файлам и файловой системе: всё общение происходит напрямую между редактором и браузером. 

Это означает:

* Файлы не надо сохранять, чтобы увидеть изменения.
* Можно работать с безымянными файлами (то есть только что созданными и не сохранёнными).
* Не важно, откуда пришел CSS-файл в редактор: из файловой системы, из сетевого диска, из FTP или его только что прислали по почте — если он открыт в редакторе, значит, его можно использовать для двунаправленного живого редактирования.

## Основные возможности:
* Работает в обоих направлениях (редактор↔браузер)
* Не требует сохранения файлов или перезагрузки страниц: патчи герерируются и применяются «на лету».
* Никак не завязан на локальную файловую структуру или конкретные CSS-файлы. Можно вживую редактировать практически любой сайт в интернете.
* Использует веб-сокеты для моментальной передачи изменений.
* Автоматически обновляет все открытые окна — идеально для тестирования отзывчивого дизайна (можно открыть несколько окон одной и той же страницы с разными размерами и следить, как меняется страница).

## Установка
Emmet LiveStyle состоит из двух частей: плагин к редактору (сервер) и расширение для браузера (клиент). На данный момент сервером является плагин для Sublime Text, а клиентом — расширение для Google Chrome.

### Клиент

1. Скачать http://download.emmet.io/livestyle/livestyle.crx
2. Скачанный livestyle.crx перетащить в окно Extensions

Все плагины настроены на автоматическое обновление, так что они будут периодически обновляться и у вас всегда будет самая свежая версия.

### Сервер
_Серверная часть нужна, как правило, только разработчикам (дизайнер, читай ниже)._ Плагин для Sublime Text можно установить через Package Control.

1. Установить Emmet. Если он установлен — убедиться, что используется самая последняя версия.
2. Установить Emmet LiveStyle. Так как его ещё нет в Package Control, нужно вручную добавить репозиторий: вызовите команду `Package Control: Add Repository` в ST2 добавьте адрес ` https://github.com/emmetio/livestyle-sublime`.


## Как пользоваться
1. Запустить Sublime Text. Плагин ELS автоматически поднимет WebSockets сервер.
2. Открыть какой-нибудь CSS-файл. На данный момент этот CSS-файл должен быть сохранён (то есть не должен быть только что созданным и не сохранённым). Это ограничение бета-версии, потом можно будет использовать и не сохранённые файлы.
3. Открыть какую-нибудь страницу в Google Chrome.
4. Открыть DevTools и перейти на вкладку Emmet LiveStyle. Живое редактирование работает *только* с активным DevTools.
5. Включить “Enable LiveStyle for current page“ и убедиться, что в правом верхнем углу отображается “Sublime Text“ (это означает, что подключение активно).
6. В секции File Mappings указать ассоциации между CSS-файлами на странице (слева) и в редакторе (справа). То есть между какими файлами будет происходить обмен патчами. Список файлов редактора обновляется автоматически при открытии/закрытии файлов в редакторе. ELS постарается сам связать файлы, если имена одинаковые.
7. При необходимости можно добавить новый CSS-файл прямо на страницу с помощью кнопки Add file. Это полезно, например, если у вас основной CSS-файл очень большой и обновление занимает много времени, или если хотите создать новый стиль, которого ещё нет на странице.

Теперь, при редактировании CSS в редакторе или в браузере (через Elements > Styles) на противоположном «конце» должны быть видны изменения.

Можно открыть несколько окон с одной и той же страницей: при активном LiveStyle и открытом DevTools во всех окнах изменения CSS, сделанные в DevTools одного окна, будут автоматически переброшены и на другие. В этом режиме удобно отлаживать responsive design.

### Режим дизайнера
Пока что экспериментальный режим, позволяющий дизайнерам на «боевом» сайте внести изменения в стили через DevTools и отправить эти изменения разработчику. Разработчик может автоматически наложить присланные изменения на исходный CSS.

Дизайнерам не нужна серверная часть (то есть редактор с плагином LiveStyle), вся работа происходит внутри DevTools так же, как описано выше.

Каждое изменени стиля записывается в _историю патчей_, которая доступна в панели Emmet LiveStyle. По умолчанию, в истории хранится последние 10 точек сохранения, новая точка создаётся после каждого обновления страницы.

В выпадающем меню Patch history, если выбрать саму точку — она применится к текущей странице; если кликнуть на иконку справа, то она будет скачана в виде JSON-файла, который можно отправить разработчику.

Напомню, что режим очень экспериментальный и требут доработки как UI, так и логики работы.


## На что обратить внимание
1. Главная цель LiveStyle — облегчить технологам работу с CSS, избавив его от рутинных операций. Поэтому мне хотелось бы получить обратную связь об удобстве использования инструмента и дальнейших улучшениях.
2. Важная часть плагина — изменение CSS-кода в редакторе. ELS старается делать это интеллектуально: анализирует текущий стиль написания CSS (отступы, разделители) и пытается применить его к новым правилам. Поэтому стоит обратить внимание, насколько точно наследуются стили и не приходится ли вручную редактировать код.
3. Правильно ли применяется патч: находятся ли нужные селекторы, обновляются ли нужные свойства.

## Известные проблемы
* Иногда в браузере изменения могут не отображаться. Скорее всего, это связано с тем, что при каждом изменении ресурса Chrome сохраняет его копию в `localStorage`, размер которого ограничен 5МБ. Поэтому, если редактируете большие файлы, хранилище быстро забьётся. Вроде разработчики должны это исправить в новых версиях Chrome.